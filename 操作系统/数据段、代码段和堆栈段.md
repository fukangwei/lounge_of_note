---
title: 数据段、代码段和堆栈段
categories: 操作系统
date: 2018-12-25 19:52:32
---
&emsp;&emsp;进程(执行的程序)会占用一定数量的内存，它或是用来存放从磁盘载入的程序代码，或是存放取自用户输入的数据等。不过进程对这些内存的管理方式因内存用途不一而不尽相同，有些内存是事先静态分配和统一回收的，而有些却是按需要动态分配和回收的。对任何一个普通进程来讲，它都会涉及到`5`种不同的数据段。下面简单归纳一下进程对应的内存空间中所包含的几种不同的数据区都是干什么的。<!--more-->
&emsp;&emsp;`BSS段`(`bss segment`)：通常是指用来存放程序中未初始化的，或者初始化为`0`的全局变量的一块内存区域。`BSS`是英文`Block Started by Symbol`的简称。`BSS`段属于静态内存分配，在整个程序运行的期间都是一直存在的。它不占用程序文件的大小，但是占用程序运行时的内存空间。`bss`段并不给该段的数据分配空间，只是记录数据所需空间的大小。
&emsp;&emsp;`数据段`(`data segment`)：通常是指用来存放程序中已初始化的全局变量的一块内存区域。数据段属于静态内存分配，在整个程序运行的期间都是一直存在的。`data`段占用程序文件的大小，其内容由程序初始化。`data`(已手动初始化的数据)段则为数据分配空间，数据保存在目标文件中。数据段包含经过初始化的全局变量以及它们的值。
&emsp;&emsp;`代码段`(`code segment/text segment`)：通常是指用来存放程序执行代码的一块内存区域。这部分区域的大小在程序运行前就已经确定，并且内存区域通常属于只读区域，某些架构也允许代码段为可写，即允许修改程序。在代码段中，也有可能包含一些只读的常数变量，例如字符串常量等。
&emsp;&emsp;`堆`(`heap`)：用于存放进程运行中被动态分配的内存段，它的大小并不固定，可动态扩张或缩减。当进程调用`malloc`等函数分配内存时，新分配的内存就被动态添加到堆上(堆被扩张)；当利用`free`等函数释放内存时，被释放的内存从堆中被剔除(堆被缩减)。
&emsp;&emsp;`栈`(`stack`)：又称为`堆栈`，用于存放程序临时创建的局部变量，也就是函数括弧`{}`中定义的变量(但不包括`static`声明的变量，`static`意味着在数据段中存放变量)。除此以外，在函数被调用时，其参数也会被压入发起调用的进程栈中，并且等到调用结束后，函数的返回值也会被存放回栈中。由于栈具有先进后出特点，所以经常用来保存和恢复调用现场。从这个意义上讲，我们可以把堆栈看成一个寄存、交换临时数据的内存区。它是由操作系统分配的，内存的申请与回收都由`OS`管理。
&emsp;&emsp;`常量数据段`：即`rodata`段，`ro`就是`Read Only`之意，常用来存放常量数据。字符串会被编译器自动放到`rodata`中，其他数据要想放到`rodata`中，只需要增加`const`关键字。关于`rodata`类型的数据，要注意以下几点：

- 常量不一定是放在`rodata`段中，有些立即数与指令编译在一起直接放在代码段中。
- 对于字符串常量，编译器会去掉重复的常量，让程序的每个字符串常量在一个可执行文件中只有一份复制。
- 在有些系统中，`rodata`段是多个进程共享的，目的是为了提高空间的利用率。
- 在嵌入式`linux`系统中，`rodata`放在`ROM`或者`Nor flash`中，运行时直接读取，无需加载到`RAM`中。
- 常量是不能修改的，修改常量在`linux`下会出现段错误。

&emsp;&emsp;**补充说明**：`BSS`段的大小从可执行文件中得到，然后链接器得到这个大小的内存块，紧跟在数据段后面。包含数据段和`BSS`段的整个区段此时通常称为`数据区`。