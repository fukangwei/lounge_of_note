---
title: RGB转灰度算法
categories: opencv和图像处理
date: 2018-12-30 19:54:48
---
&emsp;&emsp;对于彩色转灰度，有一个很著名的公式：<!--more-->

``` cpp
Gray = R * 0.299 + G * 0.587 + B * 0.114
```

而在实际应用时，希望避免低速的浮点运算，所以需要整数算法。注意到系数都是`3`位精度，可以将它们缩放`1000`倍来实现整数运算：

``` cpp
Gray = (R * 299 + G * 587 + B * 114 + 500) / 1000
```

`RGB`一般是`8`位精度，现在缩放`1000`倍，所以上面的运算是`32`位整型的运算。注意后面那个除法是整数除法，所以需要加上`500`来实现四舍五入。该算法的另一个变种可以减少计算量：

``` cpp
Gray = (R * 30 + G * 59 + B * 11 + 50) / 100
```

&emsp;&emsp;上面的整数算法已经很快了，但是仍有一点制约速度，就是最后的那个除法。移位比除法快多了，所以可以将系数缩放成`2`的整数幂。习惯上使用`16`位精度，`2`的`16`次幂是`65536`，所以这样计算系数：

``` cpp
0.299 * 65536 = 19595.264 ≈ 19595
0.587 * 65536 + (0.264) = 38469.632 + 0.264 = 38469.896 ≈ 38469
0.114 * 65536 + (0.896) = 7471.104 + 0.896 = 7472
```

这里所使用的舍入方式不是四舍五入，因为它会有较大的误差，应该将以前的计算结果误差一起计算进去，舍入方式是`去尾法`。写成表达式如下：

``` cpp
Gray = (R * 19595 + G * 38469 + B * 7472) >> 16
```

`2`至`20`位精度的系数如下：

``` cpp
Gray = (R * 1      + G * 2      + B * 1     ) >> 2
Gray = (R * 2      + G * 5      + B * 1     ) >> 3
Gray = (R * 4      + G * 10     + B * 2     ) >> 4
Gray = (R * 9      + G * 19     + B * 4     ) >> 5
Gray = (R * 19     + G * 37     + B * 8     ) >> 6
Gray = (R * 38     + G * 75     + B * 15    ) >> 7
Gray = (R * 76     + G * 150    + B * 30    ) >> 8
Gray = (R * 153    + G * 300    + B * 59    ) >> 9
Gray = (R * 306    + G * 601    + B * 117   ) >> 10
Gray = (R * 612    + G * 1202   + B * 234   ) >> 11
Gray = (R * 1224   + G * 2405   + B * 467   ) >> 12
Gray = (R * 2449   + G * 4809   + B * 934   ) >> 13
Gray = (R * 4898   + G * 9618   + B * 1868  ) >> 14
Gray = (R * 9797   + G * 19235  + B * 3736  ) >> 15
Gray = (R * 19595  + G * 38469  + B * 7472  ) >> 16
Gray = (R * 39190  + G * 76939  + B * 14943 ) >> 17
Gray = (R * 78381  + G * 153878 + B * 29885 ) >> 18
Gray = (R * 156762 + G * 307757 + B * 59769 ) >> 19
Gray = (R * 313524 + G * 615514 + B * 119538) >> 20
```

&emsp;&emsp;一道面试题：写一个函数，将一个`32`位`RGB`像素的色值转为灰度，`RGB`转灰度的公式为`Grey = 0.03 * red + 0.59 * green + 0.11 * blue`；`RGB`像素格式(左边最高位，右边最低位)为`00000000RRRRRRRRGGGGGGGGBBBBBBBB`：

``` cpp
unsigned int ToGrey ( unsigned int rgb ) {
    unsigned int blue = ( rgb & 0x000000FF ) >> 0;
    unsigned int green = ( rgb & 0x0000FF00 ) >> 8;
    unsigned int red = ( rgb & 0x00FF0000 ) >> 16;
    printf ( "\nred = %d, green = %d, blue = %d\n", red, green, blue );
    return ( red * 38 + green * 75 + blue * 15 ) >> 7;
}
```